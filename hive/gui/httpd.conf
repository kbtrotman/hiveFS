ServerRoot "/usr/local/apache2"
Listen 80

# Base modules
LoadModule mpm_event_module modules/mod_mpm_event.so
LoadModule authz_core_module modules/mod_authz_core.so
LoadModule authz_host_module modules/mod_authz_host.so
LoadModule access_compat_module modules/mod_access_compat.so
LoadModule dir_module modules/mod_dir.so
LoadModule mime_module modules/mod_mime.so
LoadModule log_config_module modules/mod_log_config.so
LoadModule unixd_module modules/mod_unixd.so
LoadModule headers_module modules/mod_headers.so

# For SPA fallback
LoadModule rewrite_module modules/mod_rewrite.so

# For reverse proxy
LoadModule proxy_module modules/mod_proxy.so
LoadModule proxy_http_module modules/mod_proxy_http.so

ServerAdmin you@example.invalid
ServerName localhost

# Logs to container stdout/stderr
ErrorLog /proc/self/fd/2
LogLevel warn
CustomLog /proc/self/fd/1 combined

# Hardening-ish
ServerTokens Prod
ServerSignature Off
TraceEnable Off

# Document root (Vite build copied here)
DocumentRoot "/usr/local/apache2/htdocs"
<Directory "/usr/local/apache2/htdocs">
    Require all granted
    Options -Indexes
    AllowOverride None
</Directory>

DirectoryIndex index.html

# --- VirtualHost ---
<VirtualHost *:80>
    # If you later put this behind TLS, these headers help Django infer scheme
    RequestHeader set X-Forwarded-Proto expr=%{REQUEST_SCHEME}
    RequestHeader set X-Forwarded-Port  expr=%{SERVER_PORT}

    # Reverse proxy API to backend (private network name: backend)
    ProxyPreserveHost On
    ProxyPass        /api/  http://backend:8000/api/
    ProxyPassReverse /api/  http://backend:8000/api/

    # SPA fallback:
    # - If request is /api/* let it proxy
    # - If file/dir exists, serve it
    # - Otherwise serve /index.html
    RewriteEngine On

    RewriteCond %{REQUEST_URI} ^/api/ [NC]
    RewriteRule ^ - [L]

    RewriteCond %{REQUEST_FILENAME} -f [OR]
    RewriteCond %{REQUEST_FILENAME} -d
    RewriteRule ^ - [L]

    RewriteRule ^ /index.html [L]
</VirtualHost>
