name: hive-prod

services:
  apache:
    build:
      context: .
      dockerfile: Dockerfile.apache
    container_name: hive-apache
    depends_on:
      - backend
    ports:
      # Only internet-facing port
      - "80:80"
    networks:
      - webnet
    read_only: true
    tmpfs:
      - /tmp
      - /usr/local/apache2/logs

  backend:
    build:
      context: .
      dockerfile: Dockerfile.backend
    container_name: hive-backend
    environment:
      DJANGO_SETTINGS_MODULE: "src.config.settings"
      PYTHONUNBUFFERED: "1"

      # DB via unix socket
      DB_SOCKET_PATH: "${DB_SOCKET_PATH:-/run/mysqld/mysqld.sock}"

      # Recommended when behind a reverse proxy
      USE_X_FORWARDED_HOST: "1"
    volumes:
      # Host sockets
      - /run/hive_bootstrap.sock:/run/hive_bootstrap.sock:rw
      - /run/mysqld/mysqld.sock:/run/mysqld/mysqld.sock:ro

    # No published ports in prod (private only)
    expose:
      - "8000"
    networks:
      - webnet

    # Optional hardening; ensure your app doesn't need writing to the rootfs
    read_only: true
    tmpfs:
      - /tmp

    # If your host's mysql socket requires group access, add the host mysql GID.
    # Example: group_add: ["118"]
    # group_add:
    #   - "${MYSQL_GID}"

networks:
  webnet:
    driver: bridge
    internal: true
